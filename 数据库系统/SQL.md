### 2. SQL

虽然Ted Codd在提出关系模型的时候一同给出了关系代数这样的数学语言来描述关系模型下数据库的查询修改更新等任务，但它几乎没有任何的实际可操作性，因此IBM在上个世纪提出了结构化查询语言（Structure Query Language，SQL）。SQL不仅提供了最基本数据库查询的功能，还提供了数据结构定义、修改数据库中数据以及说明安全性约束条件等多种功能，在实际中我们经常将其分成如下三种：

- **数据定义语言DDL**：负责提供定义关系模式、删除关系、修改关系模式、定义视图以及定义保存在数据库中数据必须满足的完整性约束条件的命令，具体包括`create`、`drop`、`alter`等。在本文中2.1、3.1、3.2节主要讲述这些知识点。

- **数据操纵语言DML**：负责提供基于关系代数和元组关系演算实现的查询语言，还包括对关系元组的更新、插入、删除等命令，实现对数据库的操纵，具体包括`select`、`insert`、`update`、`delete`等。在本文中2.2\~2.7以及3.5、3.6节主要讲述这些知识点。

  > 另有一说DML实际上是集合论（或bag代数）的产物，而非关系代数，但可以确定的是DML与关系代数是相近的，虽然在表述能力上有一些差别。

- **数据控制语言DCL**：负责提供对数据库中数据进行的变更的确认和取消，以及用户、关系的权限的授予和撤销等命令，具体包括`commit`、`rollback`、`grant`、`revoke`等命令。在本文中主要由3.3节来讲述部分的知识点。



#### 2.1 数据定义

在关系型数据库中，所有的关系集合的创建以及相关设置都是由DDL来负责指定，DDL不仅能够提供定义关系的能力，还能够设定每个关系其他重要的信息（这些信息不少可以在关系创建的时候一同设置），包括：

1. 每个关系的模式
2. 每个属性的类型/值域
3. 完整性约束
4. 每个关系维持的索引集合
5. 每个关系的安全性和权限信息
6. 磁盘上每个关系的物理存储结构

在本节中我们只介绍前两个内容，下一章介绍完整性约束。



##### 2.1.1 SQL数据类型

由于用户自定义类型在不同的数据库DBMS上没有得到广泛的支持，例如PostgreSQL支持但MySQL不支持，因此这里并不介绍这种特殊的数据类型，主要还是介绍SQL标准支持的基本域类型。在大多数的SQL中主要包含有1）串数据类型；2）数值数据类型；3）日期和时间类型；4）二进制数据类型这四种，下表总结了常见的这几种常用的细分类型：

|    细分种类    |                         常见数据类型                         |                描述                |
| :------------: | :----------------------------------------------------------: | :--------------------------------: |
|   串数据类型   |                    `char(n)`、`varchar`等                    |          定长、变长字符串          |
|  数值数据类型  | `int`、`smallint`、`numeric(p,d)`、<br />`real`、`double`、`float(n)`等 |   整数、指定精度的定点数、浮点数   |
| 日期和时间类型 |                `date`、`time`、`timestamp`等                 | 日期、时间和混合前两者的时间戳类型 |
| 二进制数据类型 |                           `blob`等                           |   名为基于`byte`的`large object`   |

上述的一些类型也进行一定程度上的相互转换，但这些转换必须用户强制指定且目标类型与源类型相兼容，且在MySQL上目标类型有着严格的限制。例如目标整数类型只能指定为`signed`，目标无符号整数只能指定为`unsigned`，目标日期时间相关的必须在`date`、`time`、`datetime`内。我们可以使用如下的语法来进行强制类型转换：

```sql
cast(<src> as <dst_type>) 或者 cast(<src> to <dst_type>)
```

特别的在日期时间类型上，绝大多数的SQL都提供了一些函数来实现信息的提取和转换。其中`<field>()`函数或者语法`extract(<field> from <d>)`可以帮助我们从日期或时间`d`中提取出某一个域（`year`、`day`、`hour`、`second`等）、`date()`/`unix_timestamp()`能够帮助我们将传入的数据转换到期望的日期时间类型，`current_date()`/`now()`能够帮助我们获取当前的日期时间、以及其他一些功能非常强大的函数。例如我们想要知道今天是今年的第几天，在MySQL上可以通过如下语句查询：

```mysql
select round(
    (
      unix_timestamp(now()) - unix_timestamp(concat(year(now()), "-01-01"))
    ) /(60 * 60 * 24)
) as nth_day;

-- 或者直接调用MySQL上的函数
select dayofyear(now()) as nth_day;
```



##### 2.1.2 基本模式定义与其他

我们可以通过如下形式的语法来创建关系：

```sql
create table <r> (
	A1 D1 [行约束],
	A2 D2 [行约束],
	...,
	An Dn [行约束],
	[完整性约束1],
	...,
	[完整性约束k],
);
```

其中`r`是关系名，`Ai`是关系r模式的一个属性名，Di是属性Ai的数据类型，上面的行约束本质上也是完整性约束的一部分，它们将在3.1节中介绍。为了后续内容的介绍，我们创建了如下三个关系并插入如下数据：

<img src="图片/Snipaste_2022-03-28_22-23-05.jpg" alt="Snipaste_2022-03-28_22-23-05" style="zoom: 67%;" />

我们可以通过insert命令来向关系中添加元组，使用delete命令来删除关系中的部分或全部元组，但由于DDL关乎的是关系模式的定义、删除和修改，所以它们都属于DML。我们可以通过drop命令来删除整个关系：

```sql
drop table <r>;
```

我们可以通过alter命令来修改关系的模式，为其添加或删除一些属性：





#### 2.2 SQL查询的基本结构

 ##### 2.2.1 查询基本结构



##### 2.2.2 as子句



##### 2.2.3 输出控制





#### 2.3 集合运算和聚集函数

##### 2.3.1 集合运算



##### 2.3.2 聚合函数



##### 2.3.3 窗口函数



#### 2.4子查询和视图

##### 2.4.1 嵌套子查询



##### 2.4.2 视图



##### 2.4.3 复杂查询



#### 2.5 连接关系

##### 2.5.1 连接类型和条件



##### 2.5.2 其他连接



#### 2.6 数据库修改

##### 2.6.1 删除/插入/更新



##### 2.6.2 事务



### 3. 高级SQL

#### 3.1 完整性约束

##### 3.1.1 单个关系上的约束



##### 3.1.2 参照完整性



#### 3.2 授权

##### 3.2.1 权限的授予



##### 3.2.2 角色



##### 3.2.3 权限的撤回



#### 3.3 函数和过程化结构

##### 3.3.1 SQL函数



##### 3.3.2 过程化结构



#### 3.4 触发器



#### 3.5 动态SQL

